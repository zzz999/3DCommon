<!DOCTYPE html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>3D仿真移动交互–迈向中国制造2025</title>
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/sm.min.css" rel="stylesheet" />
    <link href="js/fancytree/skin-lion/ui.fancytree.min.css" rel="stylesheet" />
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/fancytree/jquery.fancytree-all-deps.js"></script>
</head>
<body>
    <div class="Load-bg" id="loadingDiv">
        <div class="Load-tex">
            <div class="Load-logo">
                <em id="pecentageText">0%</em>
                <h2><span id="pecentageWidth"></span></h2>
                <p class="Load-Sketch">眸瑞科技</p>
            </div>
        </div>
    </div>
    <div class="page-group" style="background: none;">
        <div class="page page-current" style="background: none;" id="mainContainer">
            <!-- 这里是页面内容区 -->
            <ul class="gray-model-list" style="z-index: 2;">
                <li class="line-btn hasChildren" id="expose">
                    <img src="img/btn-cf.png" />
                    <div class="line-content" id="exposeSlider">
                        <div class="lineDiv" id="lineDiv1">
                            <div class="minDiv" id="minDiv1">
                            </div>
                        </div>
                    </div>
                </li>
                <li class="line-btn hasChildren">
                    <img src="img/btn-changeBgColor.png" />
                    <div class="line-content">
                        <div class="color-content body-bg">
                            <img src="img/model-detailBg1.png" />
                        </div>
                        <div class="color-content body-bg color-content-gray">
                            <img src="img/model-detailBg2.png" />
                        </div>
                        <div class="color-content body-bg color-content-white">
                            <img src="img/model-detailBg3.png" />
                        </div>
                    </div>
                </li>
                <li id="playbtn" class="line-btn">
                    <img class="btn-play" src="img/btn-play.png" />
                </li>
                <li id="strubtn" class="line-btn">
                    <img class="btn-stru" src="img/btn-stru.png" />
                    <img class="btn-stru2" src="img/btn-stru-active.png" />
                </li>
                <li id="speedBtn" class="line-btn hasChildren">
                    <img id="btnSpeed" class="img-state" src="img/btn-speed.png" />
                    <div class="line-content line-model-start">
                        <div class="color-content btn-state btn-state0">
                            <img src="img/state-0.5.png" />
                        </div>
                        <div class="color-content btn-state btn-state1">
                            <img src="img/state-1.png" />
                        </div>
                        <div class="color-content btn-state btn-state2">
                            <img src="img/state-2.png" />
                        </div>
                        <div class="color-content btn-state btn-state3">
                            <img src="img/state-3.png" />
                        </div>
                    </div>
                </li>
                <li class="line-btn hasChildren">
                    <img src="img/btn-light.png" />
                    <div class="line-content" id="ambientSlider">
                        <div class="lineDiv" id="lineDiv2">
                            <div class="minDiv" style="left: 50%" id="minDiv2">
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
            <ul class="gray-model-left-list" style="z-index: 2;">
                <li class="line-btn btn-one-content" id="btnTransparent">
                    <img class="btn-normal" src="img/btn-clarity.png" />
                    <img class="btn-active" src="img/btn-clarity-active.png" />
                </li>
                <li class="line-btn btn-one-content" id="btnShowAll">
                    <img class="btn-normal" src="img/btn-show.png" />
                    <img class="btn-active" src="img/btn-show-active.png" />
                </li>
                <li class="line-btn btn-one-content" id="btnSwitch">
                    <img class="btn-normal" src="img/btn-showHide.png" />
                    <img class="btn-active" src="img/btn-showHide-active.png" />
                </li>
                <li class="line-btn btn-one-content" id="btnHide">
                    <img class="btn-normal" src="img/btn-hide.png" />
                    <img class="btn-active" src="img/btn-hide-active.png" />
                </li>
                <li class="line-btn btn-more-content" id="btnReset">
                    <img class="btn-reset" src="img/btn-reset.png" />
                    <img class="btn-reset-active" src="img/btn-reset-active.png" />
                </li>
                <li class="line-btn btn-more-content" id="btnMove">
                    <img class="btn-move" src="img/btn-move.png" />
                    <img class="btn-move-active" src="img/btn-move-active.png" />
                </li>
                <li>
                    <img class="btn-handle" src="img/btn-handle.png" />
                </li>
            </ul>
            <div class="model-msg-tips" style="display: none; border: none; border-radius: 20px; z-index: 2;">
                请先选择模型
            </div>
            <div class="jgdiv">
                <p>结构</p>
                <div class="jgmc">
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    $(function () {
        function iterate(children, parentData) {
            children.forEach(function (child) {
                var childData = {
                    title: child.name,
                    icon: false,
                    expanded: true,
                    data: {
                        type: child.type,
                        id: child.id,
                        uuid: child.uuid
                    },
                    children: []
                }

                parentData.children.push(childData);

                if (child.children.length > 0) {
                    iterate(child.children, childData);
                }
            });
        }

        //设置背景(添加水印)
        var bgIdx = 1,
            removeLogo = false,
            customLogo = '';
        function setSceneBg() {
            var isPortrait = ('orientation' in window) ? (window.orientation == 180 || window.orientation == 0) : (window.innerWidth < window.innerHeight);

            var image = new Image();
            image.setAttribute('crossorigin', 'anonymous');
            image.addEventListener('load', function (event) {
                var myCanvas = document.createElement("canvas");
                myCanvas.width = window.innerWidth * window.devicePixelRatio;
                myCanvas.height = window.innerHeight * window.devicePixelRatio;
                var ctx = myCanvas.getContext("2d");
                //背景
                ctx.globalCompositeOperation = "destination-over";
                ctx.drawImage(this, 0, 0, myCanvas.width, myCanvas.height);

                if (removeLogo) {
                    viewer.setBackgroud(myCanvas.toDataURL('image/jpeg', 1.0));
                } else {
                    if (customLogo) {
                        var myCanvas1 = document.createElement("canvas");
                        myCanvas1.width = this.width;
                        myCanvas1.height = 98;
                        var ctx1 = myCanvas1.getContext("2d");
                        var img = new Image();
                        img.setAttribute('crossorigin', 'anonymous');
                        img.addEventListener('load', function (event) {
                            var w = this.width * (myCanvas1.height / this.height);
                            ctx1.drawImage(this, (myCanvas1.width - w) * 0.5, 0, w, myCanvas1.height);

                            //合成logo
                            ctx.globalCompositeOperation = "source-over";
                            var h = myCanvas1.height * (myCanvas.width / myCanvas1.width);
                            ctx.drawImage(myCanvas1, 0, myCanvas.height - h * 1.5, myCanvas.width, h);

                            viewer.setBackgroud(myCanvas.toDataURL('image/jpeg', 1.0));
                        }, false);
                        img.src = customLogo;
                    } else {
                        var img = new Image();
                        img.setAttribute('crossorigin', 'anonymous');
                        img.addEventListener('load', function (event) {
                            //户型内容
                            ctx.globalCompositeOperation = "source-over";
                            var h = img.height * (myCanvas.width / img.width);
                            ctx.drawImage(this, 0, myCanvas.height - h * 1.5, myCanvas.width, h);

                            viewer.setBackgroud(myCanvas.toDataURL('image/jpeg', 1.0));
                        }, false);
                        img.src = isPortrait ? 'img/plogo.png' : 'img/llogo.png';
                    }
                }
            }, false);
            image.src = isPortrait ? ('img/p' + bgIdx + '.jpg') : ('img/l' + bgIdx + '.jpg');
        }

        var timer;
        var viewer = new AMRTViewer('mainContainer',
            //options
            {
                scaleFactor: 1.5,
                developerID: '21640235',
                appID: 'qspNARcmGfET',
                secretKey: 'pmYekORCXv475WPdUuloSFTcs2ajxKg6'
            },
            //plugins
            {
                BgMusicPlugin: {},
                ExplodePlugin: {
                    //exposeFactor:1,
                    //exposeByPart:true
                },
                HierarchyPlugin: {},
                OperatePlugin: {
                    onUnSelectError: function () {
                        if (timer) {
                            $('.model-msg-tips').hide();
                            clearTimeout(timer);
                        }
                        $('.model-msg-tips').show();
                        timer = setTimeout(function () {
                            $('.model-msg-tips').hide();
                        }, 2000);
                    }
                },
                ModelSizePlugin: {},
                AmbientPlugin: {alias:'Ambient'}
            });
        viewer.setLoadingPage('loadingDiv', 'pecentageWidth', 'pecentageText');
        viewer.onInited = function () {
            viewer.onMeshLoaded.add(function () {
                //设置背景
                setSceneBg();

                //初始化UI
                initUI();

                //设置背景音效
                //viewer.BgMusicPlugin.setBackgroudMusic('sound/bgMusic.mp3', function(){
                //    viewer.BgMusicPlugin.enableMusic(true);
                //});

                //层级结构树
                var data = viewer.HierarchyPlugin.getHierarchyData();
                var treeData = [{
                    title: data.name,
                    icon: false,
                    expanded: true,
                    data: {
                        type: data.type,
                        id: data.id,
                        uuid: data.uuid
                    },
                    children: []
                }];

                iterate(data.children, treeData[0]);

                $('.jgmc').fancytree({
                    source: treeData,
                    activate: function (event, data) {
                        var obj = viewer.getObjectById(data.node.data.id);
                        if (obj && viewer.selectObj) {
                            viewer.OperatePlugin.selectObj(obj);
                        }
                    },
                    click: function (event, data) {
                        if (data.targetType === 'title' && data.node.isActive()) {
                            data.node.setActive(false);
                            viewer.OperatePlugin.selectObj(false);
                            return false;
                        }
                    }
                });
            });
            viewer.loadModel({
                m: ['u3d/yuzong/TDSA-200-气囊式受电弓总装/models/m_part1.json', 'u3d/yuzong/TDSA-200-气囊式受电弓总装/models/m_part2.json'],
                s: 'u3d/yuzong/TDSA-200-气囊式受电弓总装/tm.txt',
                t: [
                    'u3d/yuzong/TDSA-200-气囊式受电弓总装/textures/t_1.txt',
                    'u3d/yuzong/TDSA-200-气囊式受电弓总装/textures/t_2.txt'
                ],
                a: 'u3d/yuzong/TDSA-200-气囊式受电弓总装/animations/a_1.json',
                e: 'u3d/yuzong/TDSA-200-气囊式受电弓总装/envmap/e.txt'
            });
        }

        function initUI() {
            var startEventType = ((document.ontouchstart !== null) ? 'mousedown' : 'touchstart'),
                moveEventType = ((document.ontouchmove !== null) ? 'mousemove' : 'touchmove'),
                endEventType = ((document.ontouchend !== null) ? 'mouseup' : 'touchend');

            //窗口大小改变事件(有的浏览器只执行一次，有的执行两次。为防止不能拿到(特别是只执行一次的时候)准确的值，故延迟执行尺寸改变操作)
            var isResizing = false;
            window.addEventListener('resize', function () {
                if (!isResizing) {
                    setTimeout(function () {
                        if (viewer.scene) {
                            setSceneBg();
                        }
                        isResizing = false;
                    }, 100);
                }
                isResizing = true;
            }, false);

            //背景
            $('.line-content .body-bg').on(startEventType, function () {
                var index = $(this).index();
                if (index !== bgIdx) {
                    bgIdx = index;
                    setSceneBg();
                }
            });

            //速度
            $('.line-content .btn-state').on(startEventType, function () {
                var index = $(this).index();
                var val = index === 0 ? 0.5 : index;
                viewer.setSpeed(val);
                $('#btnSpeed').attr('src', 'img/btn-state-' + val + '.png');
            });


            //重置拆分
            function resetExposeUI() {
                document.getElementById('minDiv1').style.left = "0px";
                if ($('#expose').hasClass('active')) {
                    $('#expose').removeClass('active');
                }
            }

            //收起操作栏
            function resetHandleUI() {
                $(".gray-model-left-list .line-btn").hide();
                $('.btn-handle').attr("src", "img/btn-handle.png");
                $('.btn-handle').removeClass('active');
            }

            //播放
            $('#playbtn').on(startEventType, function () {
                var flag = viewer.isPlaying();
                flag = !flag;
                $('.btn-play').attr('src', flag ? 'img/btn-sport0.png' : 'img/btn-play.png');
                viewer.playAnim(flag);
                if (flag) {
                    if (viewer.ExplodePlugin.isInExposeState()) {
                        viewer.ExplodePlugin.Disperse(0);
                    }
                    resetExposeUI();

                    //收起操作栏
                    if (viewer.OperatePlugin.isInOpState()) {
                        viewer.OperatePlugin.setOpState(false);
                        resetHandleUI();
                    }
                }
            });

            //互斥按钮
            $('.gray-model-list .line-btn').on(startEventType, function () {
                if ($(this)[0].id === 'expose' && viewer.isPlaying()) {
                    $('.btn-play').attr('src', 'img/btn-play.png');
                    viewer.playAnim(false);
                    $(this).addClass('active');
                } else {
                    if ($(this).hasClass('active')) {
                        $(this).removeClass('active');
                    } else {
                        if ($(this)[0].id === 'expose' && viewer.OperatePlugin.isInOpState()) {
                            viewer.OperatePlugin.setOpState(false);
                            resetHandleUI();
                        }
                        $('.gray-model-list .line-btn').removeClass('active');
                        $(this).addClass('active');
                    }
                }
            });

            //拖拽条
            function moveLine(mainDiv, lineDiv, minDiv, onMove, onStart, onEnd) {
                var ifBool = false; //判断鼠标是否按下

                //事件
                var start = function (e) {
                    ifBool = true;
                    if (onStart) {
                        onStart();
                    }
                    if (e && e.stopPropagation) {
                        e.stopPropagation();
                    }
                }
                var move = function (e) {
                    if (ifBool) {
                        if (e && e.preventDefault) {
                            //阻止浏览器默认行为(如鼠标移动时会选择html元素)
                            e.preventDefault();
                        }
                        if (!e.touches) {    //兼容移动端
                            var x = e.clientX;
                        } else {     //兼容PC端
                            var x = e.touches[0].pageX;
                        }
                        //获取元素的绝对位置  
                        var lineDiv_left = lineDiv.offset().left; //长线条的横坐标
                        var minDiv_left = x - lineDiv_left; //小方块相对于父元素（长线条）的left值
                        if (minDiv_left >= lineDiv[0].offsetWidth - 15) {
                            minDiv_left = lineDiv[0].offsetWidth - 15;
                        }
                        if (minDiv_left < 0) {
                            minDiv_left = 0;
                        }
                        //设置拖动后小方块的left值
                        minDiv.css({ 'left': minDiv_left + 'px' });
                        onMove(minDiv_left / (lineDiv[0].offsetWidth - 15));
                    }
                }

                var end = function (e) {
                    if (ifBool) {
                        ifBool = false;
                        if (onEnd) {
                            onEnd();
                        }
                    }
                }

                //监听触摸事件
                minDiv.on(startEventType, start);
                document.addEventListener(moveEventType, move);
                document.addEventListener(endEventType, end);
            }

            //拆分模型
            moveLine($('#exposeSlider'), $('#lineDiv1'), $('#minDiv1'), function (pct) {
                viewer.ExplodePlugin.Disperse(pct);
            });

            //环境光强度
            moveLine($('#ambientSlider'), $('#lineDiv2'), $('#minDiv2'), function (pct) {
                viewer.AmbientPlugin.changeAmbient(pct);
                //or if defined plugin alias
                //viewer.Ambient.changeAmbient(pct);
            });

            //操作
            $('.btn-handle').on(startEventType, function () {
                if ($(this).hasClass('active')) {
                    viewer.OperatePlugin.setOpState(false);
                    resetHandleUI();
                } else {
                    $(".gray-model-left-list .line-btn").show();
                    $(this).attr("src", "img/btn-handle-active.png");
                    $(this).addClass('active');

                    viewer.OperatePlugin.setOpState(true);

                    if (viewer.isPlaying()) {
                        $('.btn-play').attr('src', 'img/btn-play.png');
                        viewer.playAnim(false);
                    }

                    if (viewer.ExplodePlugin.isInExposeState()) {
                        viewer.ExplodePlugin.Disperse(0);
                    }
                    resetExposeUI();
                }
            });

            //操作
            $('.gray-model-left-list .btn-more-content').on(startEventType, function () {
                var idx = $(this).index();//4移动、5复位  
                if ($(this).hasClass('active')) {
                    $(this).removeClass('active');
                    if (idx === 5) {
                        viewer.OperatePlugin.setMoveState(false);
                    }
                    else {
                        viewer.OperatePlugin.setResetState(false);
                    }
                } else {
                    $(this).addClass('active').siblings().removeClass('active');
                    if (idx === 5) {
                        viewer.OperatePlugin.setMoveState(true);
                        $('#btnReset').removeClass('active');
                    }
                    else {
                        viewer.OperatePlugin.setResetState(true);
                        $('#btnMove').removeClass('active');
                    }
                }
            });

            //隐藏
            $('#btnHide').on(startEventType, function () {
                viewer.OperatePlugin.hide();
            });

            //显隐互换
            $('#btnSwitch').on(startEventType, function () {
                viewer.OperatePlugin.switchShowHide();
            });

            //全显
            $('#btnShowAll').on(startEventType, function () {
                viewer.OperatePlugin.showAll();
            });

            //透明
            $('#btnTransparent').on(startEventType, function () {
                viewer.OperatePlugin.transparent()
            });

            //关闭未隐藏的子模块
            viewer.dom.addEventListener(startEventType, function () {
                if ($('.hasChildren').hasClass('active')) {
                    $('.hasChildren').removeClass('active');
                }
            }, true);

            //结构
            $("#strubtn").on("click", function () {
                if ($(this).hasClass("active")) {
                    $(".jgdiv").show();
                } else {
                    $(".jgdiv").hide();
                }
            })
        }

    });
</script>
</html>
